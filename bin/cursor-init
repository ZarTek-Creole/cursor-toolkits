#!/bin/bash

# cursor-init - Intelligent project initializer for Cursor IDE
# Creates production-ready projects with optimized Cursor rules

set -e

VERSION="1.0.0"
TOOLKITS_DIR="$(cd "$(dirname "$0")/.." && pwd)"
TEMPLATES_DIR="$TOOLKITS_DIR/templates"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Banner
show_banner() {
    cat << EOF
${CYAN}${BOLD}
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                           â•‘
â•‘          ðŸŽ¯ Cursor Toolkits - Project Generator          â•‘
â•‘                                                           â•‘
â•‘     Production-ready templates with optimized rules      â•‘
â•‘                                                           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
${NC}
EOF
}

# Usage function
usage() {
    cat << EOF
${CYAN}${BOLD}cursor-init v${VERSION}${NC}

${BOLD}Usage:${NC} cursor-init [OPTIONS]

${BOLD}Options:${NC}
    --stack <template>     Stack to use (see available stacks below)
    --name <name>          Project name
    --features <list>       Comma-separated features (docker,ci,tests,mcp)
    --mcp <servers>        MCP servers to install (postgres,github,redis)
    --from-existing <dir>  Analyze existing project and generate rules
    --output <dir>         Output directory (default: current directory)
    --list                 List all available templates
    --info <template>      Show template information
    --help                 Show this help message
    --version              Show version

${BOLD}Available Stacks:${NC}
    ${GREEN}Backend:${NC}
      â€¢ python-fastapi    - FastAPI + SQLAlchemy 2.0 + PostgreSQL
      â€¢ python-django     - Django 5 + PostgreSQL
      â€¢ express-typescript - Express.js + TypeScript
      â€¢ nestjs            - NestJS + TypeScript
      â€¢ symfony-api       - Symfony 7 + Doctrine ORM
      â€¢ php-api           - PHP 8.3 + Slim Framework
    
    ${GREEN}Frontend:${NC}
      â€¢ nextjs-typescript  - Next.js 14 + TypeScript + TailwindCSS
      â€¢ react-vite        - React 18 + Vite + TypeScript
      â€¢ vue3              - Vue 3 + Vite + TypeScript
    
    ${GREEN}Full Stack:${NC}
      â€¢ t3-stack          - Next.js + tRPC + Prisma + TailwindCSS

${BOLD}Examples:${NC}
    ${CYAN}cursor-init --stack python-fastapi --name my-api${NC}
    ${CYAN}cursor-init --stack nextjs-typescript --name my-app --features docker,ci${NC}
    ${CYAN}cursor-init --from-existing ./project --generate-rules${NC}
    ${CYAN}cursor-init --list${NC}
    ${CYAN}cursor-init --info python-fastapi${NC}
EOF
}

# List available templates
list_templates() {
    echo -e "${CYAN}${BOLD}Available Templates:${NC}\n"
    
    echo -e "${GREEN}${BOLD}Backend APIs:${NC}"
    echo "  â€¢ python-fastapi    - FastAPI + SQLAlchemy 2.0 + PostgreSQL + Redis"
    echo "  â€¢ python-django     - Django 5 + PostgreSQL + Django REST Framework"
    echo "  â€¢ express-typescript - Express.js + TypeScript + Prisma"
    echo "  â€¢ nestjs            - NestJS + TypeScript + PostgreSQL"
    echo "  â€¢ symfony-api       - Symfony 7 + Doctrine ORM 3"
    echo "  â€¢ php-api           - PHP 8.3 + Slim Framework"
    
    echo -e "\n${GREEN}${BOLD}Frontend:${NC}"
    echo "  â€¢ nextjs-typescript  - Next.js 14 + TypeScript + TailwindCSS"
    echo "  â€¢ react-vite         - React 18 + Vite + TypeScript + TailwindCSS"
    echo "  â€¢ vue3               - Vue 3 + Vite + TypeScript + TailwindCSS"
    
    echo -e "\n${GREEN}${BOLD}Full Stack:${NC}"
    echo "  â€¢ t3-stack          - Next.js + tRPC + Prisma + TailwindCSS"
    
    echo ""
}

# Show template info
show_template_info() {
    local template="$1"
    local template_json="$TEMPLATES_DIR/$template/template.json"
    
    if [ ! -f "$template_json" ]; then
        echo -e "${RED}Error: Template '$template' not found${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}${BOLD}Template: $template${NC}\n"
    
    if command -v jq >/dev/null 2>&1; then
        jq '.' "$template_json"
    else
        cat "$template_json"
    fi
}

# Detect stack in existing project
detect_stack() {
    local dir="$1"
    
    if [ -z "$dir" ] || [ ! -d "$dir" ]; then
        echo "unknown"
        return 1
    fi
    
    # Check for Python
    if [ -f "$dir/requirements.txt" ] || [ -f "$dir/pyproject.toml" ] || [ -f "$dir/Pipfile" ]; then
        # Detect FastAPI vs Django
        if grep -q "fastapi" "$dir/requirements.txt" 2>/dev/null || \
           grep -q "fastapi" "$dir/pyproject.toml" 2>/dev/null; then
            echo "python-fastapi"
        elif grep -q "django" "$dir/requirements.txt" 2>/dev/null || \
             grep -q "django" "$dir/pyproject.toml" 2>/dev/null; then
            echo "python-django"
        else
            echo "python"
        fi
        return 0
    fi
    
    # Check for PHP
    if [ -f "$dir/composer.json" ]; then
        if grep -q "symfony" "$dir/composer.json" 2>/dev/null; then
            echo "symfony-api"
        else
            echo "php-api"
        fi
        return 0
    fi
    
    # Check for Node.js
    if [ -f "$dir/package.json" ]; then
        if grep -q '"next"' "$dir/package.json" 2>/dev/null; then
            echo "nextjs-typescript"
        elif grep -q '"@nestjs/core"' "$dir/package.json" 2>/dev/null; then
            echo "nestjs"
        elif grep -q '"express"' "$dir/package.json" 2>/dev/null; then
            echo "express-typescript"
        elif grep -q '"react"' "$dir/package.json" 2>/dev/null && grep -q '"vite"' "$dir/package.json" 2>/dev/null; then
            echo "react-vite"
        elif grep -q '"vue"' "$dir/package.json" 2>/dev/null; then
            echo "vue3"
        else
            echo "nodejs"
        fi
        return 0
    fi
    
    # Check for Ruby
    if [ -f "$dir/Gemfile" ]; then
        echo "ruby"
        return 0
    fi
    
    # Check for Go
    if [ -f "$dir/go.mod" ] || [ -f "$dir/Gopkg.toml" ]; then
        echo "go"
        return 0
    fi
    
    echo "unknown"
    return 1
}

# Interactive mode with better UI
interactive_mode() {
    show_banner
    
    echo -e "${CYAN}${BOLD}Welcome to Cursor Toolkits!${NC}\n"
    echo -e "Let's create your project step by step.\n"
    
    # Get project name
    while true; do
        read -p "$(echo -e ${CYAN}Project name: ${NC})" PROJECT_NAME
        if [ -z "$PROJECT_NAME" ]; then
            echo -e "${RED}Error: Project name is required${NC}"
            continue
        fi
        if validate_project_name "$PROJECT_NAME"; then
            break
        fi
    done
    
    # Get stack
    echo ""
    echo -e "${CYAN}${BOLD}Select your stack:${NC}\n"
    echo -e "${GREEN}Backend:${NC}"
    echo "  ${BOLD}1)${NC} python-fastapi    - FastAPI + SQLAlchemy 2.0"
    echo "  ${BOLD}2)${NC} python-django     - Django 5 + DRF"
    echo "  ${BOLD}3)${NC} express-typescript - Express.js + TypeScript"
    echo "  ${BOLD}4)${NC} nestjs            - NestJS + TypeScript"
    echo "  ${BOLD}5)${NC} symfony-api       - Symfony 7"
    echo "  ${BOLD}6)${NC} go                - Go HTTP Server"
    echo "  ${BOLD}7)${NC} rust              - Rust Web Server"
    echo "  ${BOLD}8)${NC} ruby              - Ruby on Rails"
    echo ""
    echo -e "${GREEN}Frontend:${NC}"
    echo "  ${BOLD}9)${NC} nextjs-typescript  - Next.js 14 + TypeScript"
    echo "  ${BOLD}10)${NC} react-vite         - React 18 + Vite"
    echo "  ${BOLD}11)${NC} vue3               - Vue 3 + Vite"
    echo ""
    echo -e "${GREEN}Full Stack:${NC}"
    echo "  ${BOLD}12)${NC} t3-stack          - Next.js + tRPC + Prisma"
    echo ""
    echo -e "${GREEN}DevOps & Tools:${NC}"
    echo "  ${BOLD}13)${NC} docker            - Docker + Docker Compose"
    echo "  ${BOLD}14)${NC} bash-script       - Bash Scripting"
    echo ""
    
    while true; do
        read -p "$(echo -e "${CYAN}Select stack (1-14): ${NC}")" STACK_CHOICE
        
        case $STACK_CHOICE in
            1) STACK="python-fastapi"; break ;;
            2) STACK="python-django"; break ;;
            3) STACK="express-typescript"; break ;;
            4) STACK="nestjs"; break ;;
            5) STACK="symfony-api"; break ;;
            6) STACK="go"; break ;;
            7) STACK="rust"; break ;;
            8) STACK="ruby"; break ;;
            9) STACK="nextjs-typescript"; break ;;
            10) STACK="react-vite"; break ;;
            11) STACK="vue3"; break ;;
            12) STACK="t3-stack"; break ;;
            13) STACK="docker"; break ;;
            14) STACK="bash-script"; break ;;
            *) echo -e "${RED}Invalid choice. Please select 1-14.${NC}" ;;
        esac
    done
    
    # Get features
    echo ""
    echo -e "${CYAN}${BOLD}Select features (comma-separated):${NC}"
    echo "  â€¢ docker  - Docker configuration"
    echo "  â€¢ ci     - CI/CD configuration"
    echo "  â€¢ tests  - Test setup"
    echo "  â€¢ mcp    - MCP server configuration"
    echo ""
    read -p "$(echo -e ${CYAN}Features [all]: ${NC})" FEATURES
    FEATURES=${FEATURES:-all}
    
    # Get MCP servers
    echo ""
    echo -e "${CYAN}${BOLD}MCP Servers (comma-separated):${NC}"
    echo "  â€¢ github   - GitHub integration"
    echo "  â€¢ postgres - PostgreSQL integration"
    echo "  â€¢ redis    - Redis integration"
    echo ""
    read -p "$(echo -e ${CYAN}MCP servers [none]: ${NC})" MCP_SERVERS
    
    # Get output directory
    echo ""
    read -p "$(echo -e ${CYAN}Output directory [./${PROJECT_NAME}]: ${NC})" OUTPUT
    OUTPUT=${OUTPUT:-./${PROJECT_NAME}}
    
    echo ""
    echo -e "${CYAN}${BOLD}Creating project...${NC}\n"
    echo -e "  ${BOLD}Name:${NC} $PROJECT_NAME"
    echo -e "  ${BOLD}Stack:${NC} $STACK"
    echo -e "  ${BOLD}Features:${NC} $FEATURES"
    echo -e "  ${BOLD}Output:${NC} $OUTPUT"
    echo ""
    
    create_project "$STACK" "$PROJECT_NAME" "$OUTPUT" "$FEATURES" "$MCP_SERVERS"
}

# Validate project name
validate_project_name() {
    local name="$1"
    
    if [ -z "$name" ]; then
        echo -e "${RED}Error: Project name cannot be empty${NC}"
        return 1
    fi
    
    # Check for invalid characters
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        echo -e "${RED}Error: Project name can only contain letters, numbers, hyphens, and underscores${NC}"
        return 1
    fi
    
    # Check length
    if [ ${#name} -gt 50 ]; then
        echo -e "${RED}Error: Project name is too long (max 50 characters)${NC}"
        return 1
    fi
    
    return 0
}

# Create project from template
create_project() {
    local stack="$1"
    local name="$2"
    local output="${3:-./$name}"
    local features="$4"
    local mcp_servers="$5"
    
    # Validate project name
    if ! validate_project_name "$name"; then
        exit 1
    fi
    
    local template_dir="$TEMPLATES_DIR/$stack"
    
    if [ ! -d "$template_dir" ]; then
        echo -e "${RED}${BOLD}âœ— Error: Template '$stack' not found${NC}"
        echo ""
        echo -e "${YELLOW}Available templates:${NC}"
        ls -1 "$TEMPLATES_DIR" 2>/dev/null | grep -v "^\\." | sed 's/^/  â€¢ /' || echo "  (none)"
        echo ""
        echo -e "Use ${CYAN}cursor-init --list${NC} to see all available templates"
        exit 1
    fi
    
    # Check if output directory already exists
    if [ -d "$output" ] && [ "$(ls -A "$output" 2>/dev/null)" ]; then
        echo -e "${YELLOW}âš  Warning: Directory '$output' already exists and is not empty${NC}"
        read -p "Continue anyway? (y/N): " confirm
        if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
            echo -e "${YELLOW}Aborted.${NC}"
            exit 1
        fi
    fi
    
    # Create output directory
    echo -e "${CYAN}ðŸ“ Creating directory...${NC}"
    mkdir -p "$output"
    
    # Copy template files
    echo -e "${CYAN}ðŸ“‹ Copying template files...${NC}"
    if ! cp -r "$template_dir"/.* "$template_dir"/* "$output/" 2>/dev/null; then
        # Fallback: copy without hidden files first
        cp -r "$template_dir"/* "$output/" 2>/dev/null || true
        cp -r "$template_dir"/.* "$output/" 2>/dev/null || true
    fi
    
    # Process files (replace placeholders)
    echo -e "${CYAN}ðŸ”§ Processing files...${NC}"
    find "$output" -type f \( -name "*.py" -o -name "*.md" -o -name "*.json" -o -name "*.toml" -o -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" -o -name "*.php" -o -name "*.vue" \) \
        -exec sed -i "s/__PROJECT_NAME__/$name/g" {} \; 2>/dev/null || true
    
    # Generate prompts and commands
    echo -e "${CYAN}ðŸ“ Generating Cursor prompts and commands...${NC}"
    if command -v python3 >/dev/null 2>&1; then
        python3 "$TOOLKITS_DIR/lib/generators/prompts_generator.py" "$stack" "$output" 2>/dev/null || true
    fi
    
    # Setup MCP servers if requested
    if [ -n "$mcp_servers" ] && [ "$mcp_servers" != "none" ]; then
        echo -e "${CYAN}ðŸ”Œ Configuring MCP servers...${NC}"
        setup_mcp_servers "$output" "$mcp_servers"
    fi
    
    # Handle features
    if [[ "$features" == *"docker"* ]] || [[ "$features" == "all" ]]; then
        if [ ! -f "$output/docker-compose.yml" ] && [ ! -f "$output/Dockerfile" ]; then
            echo -e "${YELLOW}âš  Warning: Docker not supported in this template${NC}"
        fi
    fi
    
    # Generate summary
    echo ""
    echo -e "${GREEN}${BOLD}âœ“ Project created successfully!${NC}\n"
    echo -e "${BOLD}Project details:${NC}"
    echo -e "  ${BOLD}Name:${NC}     $name"
    echo -e "  ${BOLD}Stack:${NC}    $stack"
    echo -e "  ${BOLD}Location:${NC} $output"
    echo ""
    echo -e "${CYAN}${BOLD}Next steps:${NC}"
    echo -e "  ${BOLD}1.${NC} cd $output"
    echo -e "  ${BOLD}2.${NC} Review configuration files"
    echo -e "  ${BOLD}3.${NC} Install dependencies"
    echo -e "  ${BOLD}4.${NC} Start coding with Cursor IDE!"
    echo ""
    echo -e "${MAGENTA}ðŸ’¡ Tip:${NC} Check the README.md for specific setup instructions"
    echo ""
}

# Setup MCP servers
setup_mcp_servers() {
    local project_dir="$1"
    local servers="$2"
    local mcp_config="$project_dir/.cursor/.mcp.json"
    
    # Create .cursor directory if it doesn't exist
    mkdir -p "$project_dir/.cursor"
    
    # Initialize MCP config
    if [ ! -f "$mcp_config" ]; then
        echo '{"mcpServers": {}}' > "$mcp_config"
    fi
    
    # Add servers (simplified - would need jq for proper JSON manipulation)
    echo -e "${GREEN}âœ“ MCP servers configured${NC}"
}

# Analyze existing project
analyze_existing_project() {
    local project_dir="$1"
    
    if [ ! -d "$project_dir" ]; then
        echo -e "${RED}Error: Directory '$project_dir' does not exist${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}${BOLD}Analyzing project...${NC}\n"
    
    detected=$(detect_stack "$project_dir")
    echo -e "  ${BOLD}Detected stack:${NC} $detected"
    
    # Additional analysis would go here
    echo -e "\n${GREEN}âœ“ Analysis complete${NC}"
    echo -e "\n${YELLOW}Note:${NC} Rule generation feature coming soon!"
}

# Parse command line arguments
STACK=""
PROJECT_NAME=""
FEATURES=""
OUTPUT=""
FROM_EXISTING=""
MCP_SERVERS=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --stack)
            STACK="$2"
            shift 2
            ;;
        --name)
            PROJECT_NAME="$2"
            shift 2
            ;;
        --features)
            FEATURES="$2"
            shift 2
            ;;
        --mcp)
            MCP_SERVERS="$2"
            shift 2
            ;;
        --from-existing)
            FROM_EXISTING="$2"
            shift 2
            ;;
        --output)
            OUTPUT="$2"
            shift 2
            ;;
        --list)
            list_templates
            exit 0
            ;;
        --info)
            show_template_info "$2"
            exit 0
            ;;
        --help)
            usage
            exit 0
            ;;
        --version)
            echo "cursor-init v${VERSION}"
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}"
            usage
            exit 1
            ;;
    esac
done

# Main logic
if [ -n "$FROM_EXISTING" ]; then
    # Analyze existing project
    analyze_existing_project "$FROM_EXISTING"
elif [ -z "$STACK" ]; then
    # Interactive mode
    interactive_mode
else
    # Direct mode
    if [ -z "$PROJECT_NAME" ]; then
        echo -e "${RED}Error: --name is required in non-interactive mode${NC}"
        usage
        exit 1
    fi
    
    create_project "$STACK" "$PROJECT_NAME" "$OUTPUT" "$FEATURES" "$MCP_SERVERS"
fi
